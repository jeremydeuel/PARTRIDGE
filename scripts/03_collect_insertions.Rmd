---
title: "PARTRIDGE Step 3"
author: "Jeremy Deuel <jeremy.deuel@usz.ch>"
date: "26 June 2025"
output: html_document
---

# Extract insertions from tsv files generated by isa_hmmer2

Download tsv files into folder "breakpoints" before running this script

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(openxlsx)
```

## Define function to identify novel sites and import tsv files

```{r define_aggregation_function}

novel_sites <- function(file) {
  d.file <- read.table(file, header=T)
  #replace synthetised barcodes with true ones.for reads that have one
  nc.filter <- substr(d.file$rname,nchar(d.file$rname),nchar(d.file$rname))
  nc.filter <- nc.filter %in% c("A","T","C","G")
  nc <- nchar(d.file$rname)[nc.filter]
  d.file$barcode[nc.filter] <- substr(d.file$rname[nc.filter],nc-8,nc)
  
  #aggregate
  d.file |> filter(bp.delta<1) |> group_by(ltr.end, seqname, breakpoint, barcode) |> summarise(score=max(ltr.score),mapq=max(mapq)) |> group_by(ltr.end, seqname, breakpoint) |> summarise(score=sum(score),n=n(),mapq=max(mapq)) |> arrange(seqname, breakpoint) -> d.agg

  #group in chunks of 150bp
  group <- 1
  d.agg$group <- 0
  for (i in seq_len(nrow(d.agg)-1)) {
      d.agg$group[i] <- group
      if ((d.agg$seqname[i] == d.agg$seqname[i+1]) & (d.agg$breakpoint[i]+150>d.agg$breakpoint[i+1])) {
        d.agg$group[i+1] <- group
      } else {
        group <- group + 1
      }
  }
  
  #split end setting
  d.agg$ltr.end.prime <- substr(d.agg$ltr.end,1,1)
  d.agg$ltr.end.dir <- substr(d.agg$ltr.end,2,2)

  # final filtering
d.agg |> group_by(group) |> summarise(nprimes=length(unique(ltr.end.prime)), ndir=length(unique(ltr.end.dir)), dir=dplyr::first(ltr.end.dir), tsd=max(breakpoint)-min(breakpoint), max_mapq=max(mapq), first_bp=min(breakpoint)) |> filter(nprimes==2 & ndir==1) |> filter(max_mapq>39) |> left_join(d.agg) -> d.final
  
  return(d.final)

}

```

# aggregate breakpoints

You might have to adapt the line extracting the experimental ID from your filenames.

```{r}
if (file.exists("../test_data/01_raw_breakpoints.rds")) {
  d <- readRDS("../test_data/01_raw_breakpoints.rds")
} else {
  d <- NULL
  for (f in list.files("../test_data", pattern="\\.isa\\.tsv$", full.names=T)) {
    print(f)
    d.file <- novel_sites(f)
    d.file$Expt.ID <- gsub("_step2\\.isa\\.tsv$","",basename(f)) #adjust this to your naming convention
    d <- rbind(d, d.file)
  }
  saveRDS(d,"../test_data/01_raw_breakpoints.rds")
}
```

# summarise

```{r}
d  |> group_by(seqname, first_bp, Expt.ID) |> summarise(score=sum(score), n=sum(n), strand=ifelse(dplyr::first(dir)=="F","+","-")) |> mutate(name=paste0(seqname,":",first_bp)) -> d.all
d.all |> group_by(name) |> summarise(n_mice=length(unique(Expt.ID))) |> full_join(d.all) -> d.all
```

# read metadata

Generate an Excel Table with your metadata, use "Expt.ID" as the column linking the experimental ID extracted from the filename to other metadata.

```{r}
edf <- read.xlsx("../test_data/metadata.xlsx")
```
# draw raw output and generate is_hmmer2_out file.

```{r draw_figures}
ggplot(d.all |> filter(n_mice==1) |> inner_join(edf), aes(x=mouse,y=name,color=log10(n))) + geom_point() + facet_grid(~HNRNPA1, scales="free_x", space="free_x") + theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5))
ggsave("../test_data/raw_somatic.pdf",width=12,height=24)
if (sum(d.all$n_mice>1)) {
ggplot(d.all |> filter(n_mice>1) |> inner_join(edf), aes(x=mouse,y=name,color=log10(n))) + geom_point() + facet_grid(~HNRNPA1, scales="free_x", space="free_x") + theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5))
ggsave("../test_data/raw_germline.pdf",width=12,height=8)
}
openxlsx::write.xlsx(d.all |> inner_join(edf), "../test_data/isa_hmmer2_out.xlsx")
openxlsx::write.xlsx(d.all |> inner_join(edf) |> group_by(name, seqname, first_bp, strand) |> summarise(nmice=length(unique(Expt.ID)),firstmouse=dplyr::first(Expt.ID)) |> mutate(mouse=ifelse(nmice>1,"multi",as.character(firstmouse))) |> select(name, seqname,strand, first_bp, mouse), "../test_data/isa.audit.xlsx")

```

```{r}
sessionInfo()
```
